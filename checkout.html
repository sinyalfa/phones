<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CETS Mobile Sales — Checkout</title>

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    :root{
      --bg1:#07102a;
      --bg2:#020617;
      --card: rgba(17, 29, 56, 0.72);
      --border: rgba(148, 163, 184, 0.18);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --blue:#3b82f6;
      --green:#10b981;
      --red:#ef4444;
      --amber:#f59e0b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(circle at 20% 10%, #12214b 0%, var(--bg1) 30%, var(--bg2) 80%);
      min-height:100vh;
      padding: 28px 18px;
    }

    .wrap{ max-width: 1120px; margin: 0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .title{
      font-size: 40px;
      font-weight: 950;
      margin: 0;
      letter-spacing: .3px;
    }
    .subtitle{
      margin-top: 6px;
      color: var(--muted);
      font-weight: 700;
    }

    .btn{
      height: 46px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 0 14px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      transition: transform .08s ease, box-shadow .12s ease, opacity .12s ease;
      text-decoration:none;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 30px rgba(0,0,0,.45); }
    .btn:active{ transform: translateY(0px); box-shadow: 0 10px 18px rgba(0,0,0,.35); }
    .btn.blue{ background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.90)); border-color: rgba(59,130,246,.25); }
    .btn.gray{ background: rgba(148,163,184,.12); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .card{
      background: linear-gradient(180deg, var(--card), rgba(8, 15, 35, 0.74));
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-head{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(148,163,184,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap: wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid var(--border);
      font-weight: 950;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--blue);
      box-shadow: 0 0 14px rgba(59,130,246,.45);
    }
    .dot.ok{ background: var(--green); box-shadow: 0 0 14px rgba(16,185,129,.45); }
    .dot.bad{ background: var(--red); box-shadow: 0 0 14px rgba(239,68,68,.55); }
    .dot.warn{ background: var(--amber); box-shadow: 0 0 14px rgba(245,158,11,.45); }

    .card-body{
      padding: 16px 18px 18px;
    }

    .msg{
      margin-bottom: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(0,0,0,.25);
      font-weight: 900;
      color: rgba(226,232,240,.95);
      word-break: break-word;
    }
    .msg.ok{ border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.10); }
    .msg.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); }
    .msg.warn{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08); }

    #checkout{
      min-height: 520px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(0,0,0,.18);
      padding: 10px;
    }

    .tiny{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 800;
      color: rgba(148,163,184,.95);
      line-height: 1.45;
    }

    @media (max-width: 820px){
      .title{ font-size: 32px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1 class="title">Checkout</h1>
        <div class="subtitle">Secure payment + shipping address via Stripe (Embedded Checkout).</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn blue" href="https://sinyalfa.github.io/phones/">← Back to Shop</a>
        <button class="btn gray" id="btnClear">Clear Cart</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="pill">
          <span class="dot" id="cartDot"></span>
          <span id="cartText">Cart items: 0</span>
        </div>

        <div class="pill">
          <span class="dot warn" id="statusDot"></span>
          <span id="statusText">Status: Loading…</span>
        </div>
      </div>

      <div class="card-body">
        <div id="msg" class="msg warn">Preparing checkout…</div>
        <div id="checkout"></div>
        <div class="tiny" id="debugLine"></div>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * CONFIG — CHANGE ONLY THIS ONE LINE (pk_test...)
     ************************************************************/
    const STRIPE_PUBLISHABLE_KEY = "pk_test_REPLACE_ME"; // <-- put your pk_test_... here

    const API_BASE = "https://cets-stripe-api.sinyalfa.workers.dev";
    const SUCCESS_URL = "https://sinyalfa.github.io/phones/success.html";
    const CANCEL_URL  = "https://sinyalfa.github.io/phones/checkout.html";

    /************************************************************
     * DOM
     ************************************************************/
    const $ = (id) => document.getElementById(id);
    const msg = $("msg");
    const debugLine = $("debugLine");

    const cartDot = $("cartDot");
    const cartText = $("cartText");

    const statusDot = $("statusDot");
    const statusText = $("statusText");

    $("btnClear").addEventListener("click", () => {
      // clear common localStorage + sessionStorage cart keys
      const keys = ["cart","phones_cart","cets_cart","shoppingCart","CART","store_cart"];
      keys.forEach(k => localStorage.removeItem(k));
      keys.forEach(k => sessionStorage.removeItem(k));
      // also clear anything cart-like (optional safe sweep)
      for (const k of Object.keys(localStorage)){
        if (k.toLowerCase().includes("cart")) localStorage.removeItem(k);
      }
      for (const k of Object.keys(sessionStorage)){
        if (k.toLowerCase().includes("cart")) sessionStorage.removeItem(k);
      }
      location.reload();
    });

    function setStatus(kind, text){
      statusDot.classList.remove("ok","bad","warn");
      if (kind === "ok") statusDot.classList.add("ok");
      if (kind === "bad") statusDot.classList.add("bad");
      if (kind === "warn") statusDot.classList.add("warn");

      statusText.textContent = text;

      msg.className = "msg " + (kind === "ok" ? "ok" : kind === "bad" ? "bad" : "warn");
      msg.textContent = text;
    }

    function setCartCount(n){
      cartText.textContent = `Cart items: ${n}`;
      cartDot.classList.toggle("ok", n > 0);
      cartDot.classList.toggle("bad", n === 0);
    }

    /************************************************************
     * CART LOADER (ROBUST)
     * - Tries known keys first
     * - Then scans ALL localStorage + sessionStorage for cart-like arrays
     ************************************************************/
    function parseCartArray(raw) {
      if (!raw) return null;
      try {
        const p = JSON.parse(raw);

        const arr =
          Array.isArray(p) ? p :
          Array.isArray(p?.items) ? p.items :
          Array.isArray(p?.cart) ? p.cart :
          Array.isArray(p?.data) ? p.data :
          null;

        if (!arr || !arr.length) return null;

        // must contain at least one item with an id-ish field
        const ok = arr.some(it => it?.id || it?.sku || it?.product_id);
        return ok ? arr : null;
      } catch {
        return null;
      }
    }

    function scanStorage(store, storeName){
      let best = null;

      for (const k of Object.keys(store)) {
        const raw = store.getItem(k);
        const arr = parseCartArray(raw);
        if (!arr) continue;

        // score by how cart-like it is
        const score = arr.reduce((s, it) => {
          const hasId = !!(it?.id || it?.sku || it?.product_id);
          const hasQty = Number.isFinite(Number(it?.quantity ?? it?.qty ?? it?.count ?? 1));
          return s + (hasId ? 2 : 0) + (hasQty ? 1 : 0);
        }, 0);

        if (!best || score > best.score) best = { key: k, arr, score, storeName };
      }

      return best;
    }

    function loadCart(){
      // 1) Preferred keys first
      const preferredKeys = ["cart", "phones_cart", "cets_cart", "shoppingCart", "CART", "store_cart"];
      for (const k of preferredKeys){
        const rawL = localStorage.getItem(k);
        const arrL = parseCartArray(rawL);
        if (arrL) return { arr: arrL, source: `localStorage:${k}` };

        const rawS = sessionStorage.getItem(k);
        const arrS = parseCartArray(rawS);
        if (arrS) return { arr: arrS, source: `sessionStorage:${k}` };
      }

      // 2) Scan everything
      const bestLocal = scanStorage(localStorage, "localStorage");
      const bestSess  = scanStorage(sessionStorage, "sessionStorage");

      const best = (!bestLocal && !bestSess) ? null :
                   (!bestSess) ? bestLocal :
                   (!bestLocal) ? bestSess :
                   (bestSess.score > bestLocal.score ? bestSess : bestLocal);

      if (best){
        console.log("✅ Using cart from:", best.storeName, best.key, best.arr);
        return { arr: best.arr, source: `${best.storeName}:${best.key}` };
      }

      return { arr: [], source: "none" };
    }

    // Normalize to what your Worker expects: [{id, quantity}]
    function normalizeCartItems(cart){
      return (cart || [])
        .map(it => ({
          id: it.id || it.sku || it.product_id,
          quantity: Number(it.quantity ?? it.qty ?? it.count ?? 1)
        }))
        .filter(x => x.id && Number.isFinite(x.quantity) && x.quantity > 0);
    }

    /************************************************************
     * WORKER CALL: Create Stripe Embedded Checkout session
     ************************************************************/
    async function createCheckoutSession(items){
      const res = await fetch(`${API_BASE}/create-checkout-session`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          items,
          success_url: SUCCESS_URL,
          cancel_url: CANCEL_URL
        }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok){
        throw new Error(data.error || "Failed to create checkout session");
      }
      if (!data.client_secret){
        throw new Error("Worker response missing client_secret");
      }
      return data.client_secret;
    }

    /************************************************************
     * STRIPE EMBEDDED CHECKOUT INIT
     ************************************************************/
    async function boot(){
      const { arr: rawCart, source } = loadCart();
      const items = normalizeCartItems(rawCart);

      const totalQty = items.reduce((a, x) => a + x.quantity, 0);
      setCartCount(totalQty);

      debugLine.textContent =
        `Cart source: ${source} • Items detected: ${items.length} • API: ${API_BASE}`;

      if (!items.length){
        setStatus("bad", "Your cart is empty (checkout couldn't find it). Go back and add a phone, then try again.");
        return;
      }

      if (!STRIPE_PUBLISHABLE_KEY || STRIPE_PUBLISHABLE_KEY.includes("pk_live_51T0fv2P5Fv92QeLmJ4DYLrXom8a1GkFm92ldjQrxiGZeEbx1C0o2gexi5InogZ1FNaYQbtPZxiXmYR2jHcncnryi00kQid9jej")){
        setStatus("bad", "Missing Stripe publishable key (pk_test_...). Add it in checkout.html.");
        return;
      }

      setStatus("warn", "Creating secure Stripe session…");

      const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

      const clientSecret = await createCheckoutSession(items);

      setStatus("ok", "Checkout ready. Complete payment below.");

      const embedded = await stripe.initEmbeddedCheckout({ clientSecret });
      embedded.mount("#checkout");
    }

    boot().catch(err => {
      setStatus("bad", "Checkout error: " + (err?.message || "Unknown error"));
      console.error(err);
    });
  </script>
</body>
</html>
